<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="EvaluationItemMapper">
	
	<!-- 단위 콤보 조회 -->
	<select id="selectUnitList" parameterType="map" resultType="map">
		SELECT UNIT_GROUP_CD
		     , UNIT_CD
		     , UNIT_NM
		     , CNVS_CFC
		     , BSCS_YN
		     , USE_YN
		     , SORT_SEQ 
		     , RMRK_CN
		  FROM CM_UNIT
		 WHERE USE_YN = 'Y'
	  ORDER BY SORT_SEQ 
	</select>
	
	<!-- 목록 조회 -->
	<select id="selectList" parameterType="map" resultType="map">
    	SELECT A1.TEST_ARTCL_CD
    	     , A1.UP_TEST_ARTCL_CD
    	     , A1.TEST_ARTCL_NM
    	     , A1.SYS_YN
    	     , A1.RLS_YN
    	     , A1.UNIT_CD
    	     , A1.SORT_SEQ
    	     , A1.ATCH_FILE_CD
    		 , A2.ULD_FILE_NM
             , A2.FILE_EXTN_NM
             , A3.UNIT_NM
    		 , A4.APLCN_BGNG_YR
    		 , A4.APLCN_END_YR
    		 , CASE WHEN A4.DRCT_INPT_YN = 'Y' THEN '직접입력' 
    		 		WHEN A4.DRCT_INPT_YN = 'N'  
    		 		THEN CONCAT(TRIM(TRAILING '.' FROM TRIM(TRAILING '0' FROM MIN(A5.MIN_SCR))),' ~ '
    		 		   , TRIM(TRAILING '.' FROM TRIM(TRAILING '0' FROM MAX(A5.MAX_SCR))))
    		 		WHEN MIN(A5.MIN_SCR) = MAX(A5.MAX_SCR) THEN MAX(A5.MAX_SCR)
	           		ELSE MAX(A5.MAX_SCR)
	       		END AS SCORE
	  	  FROM TN_CAR_TEST A1
	  	  LEFT JOIN CM_ATCH_FILE A2 
	        ON A1.ATCH_FILE_CD = A2.ATCH_FILE_CD
	  	  LEFT JOIN CM_UNIT A3 
	        ON A1.UNIT_CD = A3.UNIT_CD
	  	  LEFT JOIN TN_CAR_TEST_PRD A4 
	        ON A1.TEST_ARTCL_CD = A4.TEST_ARTCL_CD
	       AND A4.APLCN_BGNG_YR = ( SELECT MAX(APLCN_BGNG_YR)
	                				  FROM TN_CAR_TEST_PRD
	               					 WHERE TEST_ARTCL_CD = A1.TEST_ARTCL_CD)
	  	  LEFT JOIN TN_CAR_TEST_SCOR A5
	        ON A4.TEST_ARTCL_PRD_CD = A5.TEST_ARTCL_PRD_CD
		 <where>
        	<if test='SYS_YN == "Y"'>
        	  A1.SYS_YN = 'Y'
        	</if>
        	<if test='UP_TEST_ARTCL_CD != null and UP_TEST_ARTCL_CD != ""'>
        	  AND A1.UP_TEST_ARTCL_CD = #{UP_TEST_ARTCL_CD} 
        	</if>
            <if test='SEARCH_TEST_ARTCL_NM != null and SEARCH_TEST_ARTCL_NM != ""'>
              AND INSTR(UPPER(A1.TEST_ARTCL_NM), UPPER(#{SEARCH_TEST_ARTCL_NM})) > 0
            </if>
            <if test='SEARCH_RLS_YN != null and SEARCH_RLS_YN.size > 0'>
                <foreach open = "AND A1.RLS_YN IN (" close=")" collection="SEARCH_RLS_YN" item="item" separator=",">#{item}</foreach>
            </if>
        </where>
		 GROUP BY A1.TEST_ARTCL_CD
		 ORDER BY A1.SORT_SEQ, A1.TEST_ARTCL_CD 
	</select>
	
	<!-- 배점기간 목록 조회 -->
	<select id="selectApplyList" parameterType="map" resultType="map">
   		SELECT A1.TEST_ARTCL_PRD_CD
		     , A1.TEST_ARTCL_CD 
		     , A1.APLCN_BGNG_YR 
		     , A1.APLCN_END_YR 
		     , A1.DRCT_INPT_YN 
		     , A1.INDIV_YN 
		     , CASE 
                 WHEN A1.APLCN_BGNG_YR = (SELECT MAX(APLCN_BGNG_YR) FROM TN_CAR_TEST_PRD WHERE TEST_ARTCL_CD = #{TEST_ARTCL_CD}) THEN 'Y'
                 ELSE 'N'
                END AS MAX_FLAG
             , 'N' AS NEW_FLAG
             , CASE WHEN A1.DRCT_INPT_YN = 'N'
    		 		THEN CONCAT(TRIM(TRAILING '.' FROM TRIM(TRAILING '0' FROM MIN(A2.MIN_SCR))),' ~ '
    		 		   , TRIM(TRAILING '.' FROM TRIM(TRAILING '0' FROM MAX(A2.MAX_SCR))))
    		 		WHEN MIN(A2.MIN_SCR) = MAX(A2.MAX_SCR) THEN MAX(A2.MAX_SCR)
	       		END AS SCORE
		  FROM TN_CAR_TEST_PRD A1
	 LEFT JOIN TN_CAR_TEST_SCOR A2 
	        ON A1.TEST_ARTCL_PRD_CD = A2.TEST_ARTCL_PRD_CD
		 WHERE A1.TEST_ARTCL_CD = #{TEST_ARTCL_CD}
      GROUP BY A1.TEST_ARTCL_PRD_CD
      ORDER BY A1.APLCN_BGNG_YR
	</select>
	
	<!-- 상세조회 -->
	<select id="selectInfo" parameterType="map" resultType="map">
    SELECT A1.TEST_ARTCL_CD, A1.UP_TEST_ARTCL_CD
    	 , (SELECT TEST_ARTCL_NM FROM TN_CAR_TEST WHERE TEST_ARTCL_CD = #{UP_TEST_ARTCL_CD}) AS UP_TEST_ARTCL_NM
	     , A1.TEST_ARTCL_NM 
	     , A1.SYS_YN 
	     , CASE A1.SYS_YN WHEN 'Y' THEN '시스템' ELSE NULL END AS SYS_YN_NM
	     , A1.RLS_YN 
	     , A1.UNIT_CD
	     , A1.ATCH_FILE_CD
	     , A2.ULD_FILE_NM
		 , A2.ULD_FILE_NM AS ORGNL_ULD_FILE_NM 
	     , A2.FILE_SZ
         , A2.ORGNL_FILE_NM
         , A2.FILE_EXTN_NM
         , A2.WDTH_SZ
         , A2.VRTC_SZ
         , A3.USER_NM AS MDFCN_USER_NM
         , DATE_FORMAT(A1.MDFCN_DT, '%Y-%m-%d') AS MDFCN_DT
         , A1.SORT_SEQ
	  FROM TN_CAR_TEST A1
	  LEFT JOIN CM_ATCH_FILE A2
		ON A1.ATCH_FILE_CD = A2.ATCH_FILE_CD 
	  LEFT JOIN TN_USER A3
	    ON A1.MDFCN_USER_CD = A3.USER_CD  
     WHERE A1.TEST_ARTCL_CD = #{TEST_ARTCL_CD}
     ORDER BY A1.SORT_SEQ 
	</select>
	
	<insert id="merge" parameterType="map">
        <selectKey resultType="String" keyProperty="TEST_ARTCL_CD" order="BEFORE">
            SELECT IFNULL(#{TEST_ARTCL_CD}, FN_GET_KEYCODE())
        </selectKey>
        INSERT INTO TN_CAR_TEST (
               TEST_ARTCL_CD
             , UP_TEST_ARTCL_CD
             , TEST_ARTCL_NM
             , SYS_YN
             , RLS_YN
             , UNIT_CD
             , SORT_SEQ
             , ATCH_FILE_CD
             , REG_USER_CD
             , REG_USER_IP
             , REG_DT
             , MDFCN_USER_CD
             , MDFCN_USER_IP
             , MDFCN_DT
        )
        VALUES (
               #{TEST_ARTCL_CD}
             , #{UP_TEST_ARTCL_CD}
             , #{TEST_ARTCL_NM}
             , #{SYS_YN}
             , #{RLS_YN}
             , #{UNIT_CD}
             , #{SORT_SEQ}
             , #{ATCH_FILE_CD}
             , #{SESSION_USER_CD}
             , #{SESSION_USER_IP}
             , NOW()
             , #{SESSION_USER_CD}
             , #{SESSION_USER_IP}
             , NOW()
        )
        ON DUPLICATE KEY UPDATE
           TEST_ARTCL_NM = #{TEST_ARTCL_NM}
         , SYS_YN = #{SYS_YN}
         , RLS_YN = #{RLS_YN}
         , UNIT_CD = #{UNIT_CD}
         , SORT_SEQ = #{SORT_SEQ}
         , ATCH_FILE_CD = #{ATCH_FILE_CD}
         , MDFCN_USER_CD = #{SESSION_USER_CD}
         , MDFCN_USER_IP = #{SESSION_USER_IP}
         , MDFCN_DT = NOW()
	</insert>
	
	<!-- 적용기간: delete -->
	<delete id="deletePrd" parameterType="map">
        DELETE FROM TN_CAR_TEST_PRD
         WHERE TEST_ARTCL_PRD_CD = #{TEST_ARTCL_PRD_CD}
	</delete>
	
	<!-- 시험항목 제거 -->
	<delete id="delete" parameterType="map">
        DELETE FROM TN_CAR_TEST
         WHERE TEST_ARTCL_CD = #{TEST_ARTCL_CD}
	</delete>
	
	<!-- 적용기간: merge -->
	<insert id="mergePrd" parameterType="map">
        <selectKey resultType="String" keyProperty="TEST_ARTCL_PRD_CD" order="BEFORE">
            SELECT IFNULL(#{TEST_ARTCL_PRD_CD}, FN_GET_KEYCODE())
        </selectKey>
        INSERT INTO TN_CAR_TEST_PRD (
               TEST_ARTCL_PRD_CD  
             , TEST_ARTCL_CD
             , APLCN_BGNG_YR
             , APLCN_END_YR
             , DRCT_INPT_YN
             , REG_USER_CD
             , REG_USER_IP
             , REG_DT
             , MDFCN_USER_CD
             , MDFCN_USER_IP
             , MDFCN_DT
        )
        VALUES (
               #{TEST_ARTCL_PRD_CD}
             , #{TEST_ARTCL_CD}
             , #{APLCN_BGNG_YR}
             , #{APLCN_END_YR}
             , #{DRCT_INPT_YN}
             , #{SESSION_USER_CD}
             , #{SESSION_USER_IP}
             , NOW()
             , #{SESSION_USER_CD}
             , #{SESSION_USER_IP}
             , NOW()
        )
        ON DUPLICATE KEY UPDATE
           APLCN_BGNG_YR = #{APLCN_BGNG_YR}
         , APLCN_END_YR = #{APLCN_END_YR}
         , DRCT_INPT_YN = #{DRCT_INPT_YN}
         , MDFCN_USER_CD = #{SESSION_USER_CD}
         , MDFCN_USER_IP = #{SESSION_USER_IP}
         , MDFCN_DT = NOW()
	</insert>
	
	<!-- 팝업: 배점기준 목록 조회 -->
	<select id="selectScoreList" parameterType="map" resultType="map">
    	SELECT SCOR_CRTR_CD
    	     , TEST_ARTCL_PRD_CD
    	     , TEST_GRD
    	     , MIN_SCR
    	     , MAX_SCR
    	     , MIN_SCR AS MIN_MAX_SCR
    	     , SCR_EXPLN
    	     , SORT_SEQ
    	  FROM TN_CAR_TEST_SCOR 
    	 WHERE TEST_ARTCL_PRD_CD = #{TEST_ARTCL_PRD_CD}
      ORDER BY SORT_SEQ
	</select>
	
	<!-- 팝업: 배점기준 info -->
	<select id="selectScoreInfo" parameterType="map" resultType="map">
    	SELECT INDIV_YN
    	  FROM TN_CAR_TEST_PRD
    	 WHERE TEST_ARTCL_PRD_CD = #{TEST_ARTCL_PRD_CD}
	</select>
	
	<!-- 팝업: 배점기준 Merge -->
	<insert id="mergeScore" parameterType="map">
        <selectKey resultType="String" keyProperty="SCOR_CRTR_CD" order="BEFORE">
            SELECT IFNULL(#{SCOR_CRTR_CD}, FN_GET_KEYCODE())
        </selectKey>
        INSERT INTO TN_CAR_TEST_SCOR (
               SCOR_CRTR_CD
             , TEST_ARTCL_PRD_CD
             , TEST_GRD
             , MIN_SCR
             , MAX_SCR
             , SCR_EXPLN
             , SORT_SEQ
             , REG_USER_CD
             , REG_USER_IP
             , REG_DT
             , MDFCN_USER_CD
             , MDFCN_USER_IP
             , MDFCN_DT
        )
        VALUES (
               #{SCOR_CRTR_CD}
             , #{TEST_ARTCL_PRD_CD}
             , #{TEST_GRD}
             , #{MIN_SCR}
             , #{MAX_SCR}
             , #{SCR_EXPLN}
             , #{SORT_SEQ}
             , #{SESSION_USER_CD}
             , #{SESSION_USER_IP}
             , NOW()
             , #{SESSION_USER_CD}
             , #{SESSION_USER_IP}
             , NOW()
        )
        ON DUPLICATE KEY UPDATE
           TEST_GRD = #{TEST_GRD}
         , MIN_SCR = #{MIN_SCR}
         , MAX_SCR = #{MAX_SCR}
         , SCR_EXPLN = #{SCR_EXPLN}
         , SORT_SEQ = #{SORT_SEQ}
         , MDFCN_USER_CD = #{SESSION_USER_CD}
         , MDFCN_USER_IP = #{SESSION_USER_IP}
         , MDFCN_DT = NOW()
	</insert>
	
	<!-- 팝업: 배점기준 delete -->
	<delete id="deleteScore" parameterType="map">
        DELETE FROM TN_CAR_TEST_SCOR
         WHERE SCOR_CRTR_CD = #{SCOR_CRTR_CD}
	</delete>
	
	<!-- 배점기간 단일여부 update -->
	<update id="updatePrdIndiv" parameterType="map">
		UPDATE TN_CAR_TEST_PRD 
		   SET INDIV_YN = #{INDIV_YN}
		 WHERE TEST_ARTCL_PRD_CD = #{TEST_ARTCL_PRD_CD}
	</update>
	
	<!-- 팝업: 배점기준 deleteAll -->
	<delete id="deleteScoreAll" parameterType="map">
        DELETE FROM TN_CAR_TEST_SCOR
         WHERE TEST_ARTCL_PRD_CD = #{TEST_ARTCL_PRD_CD}
	</delete>
	
	<!-- 적용기간 deleteAll -->
	<delete id="deletePrdAll" parameterType="map">
        DELETE FROM TN_CAR_TEST_PRD
         WHERE TEST_ARTCL_CD = #{TEST_ARTCL_CD}
	</delete>
	
	
</mapper>