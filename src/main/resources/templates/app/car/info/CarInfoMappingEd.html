<th:block layout:decorate="~{${layoutName}}">
<!-- 페이지 content(ui) -->
<main layout:fragment="pageContent" class="content">
	<div class="container-fluid p-0">
	    <!-- s : 내용 시작 -->
	    <div class="row align-items-center content-head">
	        <div class="col-md-6">
	            <h2 class="h1 mb-0 col-md-auto">자동차 모델 매핑</h2>
	        </div>
	        <div class="col-md-6">
	            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
	                <ol class="breadcrumb mb-0 justify-content-end">
	                    <li class="breadcrumb-item" aria-current="page"><i
	                            class="fas fa-home me-1"></i>홈</li>
	                    <li class="breadcrumb-item" aria-current="page">자동차 정보</li>
	                    <li class="breadcrumb-item" aria-current="page">자동차 모델 매핑</li>
	                </ol>
	            </nav>
	        </div>
	    </div>
	    <div class="card">
	        <div class="card-body">
	            <div class="row">
	                <div class="col-sm-3">
	                    <div class="subtitle-wrap row">
	                        <div class="col-md-6">
	                            <h3 class="card-title">자동차 모델</h3>
	                        </div>
	                    </div>
	                    <!-- s : tree-wrap -->
	                    <div class="tree-wrap">
	                        <ul id="treeDemo" class="ztree"></ul>
	                    </div>
	                    <!-- e : tree-wrap -->
	                </div>
	                <div class="col-sm">
	                    <!-- e : subtitle-wrap -->
	                    <div class="subtitle-wrap row">
	                        <div class="col-md-6">
	                            <h3 class="card-title">자동차 그룹</h3>
	                        </div>
	                        <div class="col-md-6">
	                            <div class="text-sm-end">
	                            	<button id="btnNew" class="btn btn-outline-primary "><i class="fas fa-plus me-2"></i>신규</button>
	                                <button id="btnSave" class="btn btn-primary"><i class="fas fa-save me-2"></i>저장</button>
	                                <button id="btnCopy" class="btn btn-outline-primary "><i class="fas fa-clone me-2"></i>복사</button>
	                                <button id="btnDelete" class="btn btn-outline-primary"><i class="fa-solid fa-trash me-2"></i>삭제</button>
	                            </div>
	                        </div>
	                    </div>
	                    <!-- e : subtitle-wrap -->
	                    <form id="myForm">
	                    	<div class="table-form">
								<table class="table table-bordered align-middle">
									<colgroup>
										<col width="110">
										<col width="*">
										<col width="110">
										<col width="*">
									</colgroup>
									<tbody>
										<tr>
											<th>
												<label for="CAR_MDL_GROUP_NM" class="col-form-label required">자동차 그룹</label>
											</th>
											<td colspan="3">
												<input type="text" name="CAR_MDL_GROUP_NM" id="CAR_MDL_GROUP_NM" class="form-control" required="required">
											</td>
										</tr>
										<tr>
											<th>
												<label class="col-form-label">최종수정일</label>
											</th>
											<td>
												<input type="text" name="MDFCN_DT" id="MDFCN_DT" class="form-control readonly" readonly>
											</td>
											<th>
												<label class="col-form-label">최종수정자</label>
											</th>
											<td>
												<input type="text" name="MDFCN_USER_NM" id="MDFCN_USER_NM" class="form-control readonly"  readonly>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
		                </form>
	                    <!-- e : subtitle-wrap -->
	                    <div class="subtitle-wrap row">
	                        <div class="col-md-6">
	                            <h3 class="card-title">유사 모델 매핑 정보</h3>
	                        </div>
	                    </div>
	                    <!-- e : subtitle-wrap -->
	                    <!-- s : data-table-wrap -->
						<div class="data-table-wrap">
							<table id="MAPP_LIST" class="table table-striped w-100 nowrap"></table>
						</div>
						<!-- e : data-table-wrap -->
	                </div>
	            </div>
	
	        </div>
	    </div>
	    
	    <!-- e : 내용 끝 -->
	</div>

</main>
	
<!-- 페이지 script -->
<th:block layout:fragment="pageScript">
<script th:inline="javascript">
const  myapp = (function() {
	let myapp = {};
	
	<!--/* 조회 설정 */-->
	myapp.setView = function(viewType) {
		if(viewType == "NEW") {
			$("#btnDelete, #btnCopy").prop("disabled", true);
			$("#btnSave, #btnAddPopup, #myForm :disabled").prop("disabled", false);
			Common.clearFormData("myForm");
			myapp.searchInfo();
		}else if(viewType == "EDIT") {
			$("#btnNew, #btnSave, #btnDelete, #btnCopy, #btnAddPopup, #myForm :input:disabled").prop("disabled", false);
		}else if(viewType == "COPY"){
			$("#btnDelete, #btnNew").prop("disabled", true);
			$("#btnSave, #myForm :disabled").prop("disabled", false);
			Common.clearFormData("myForm");
		}else {
			$("#btnSave, #btnDelete, #btnCopy, #btnAddPopup, #myForm :input:not([readonly])").prop("disabled", true);
			Common.clearFormData("myForm");
			myapp.searchInfo();
		}
	}
	
	DataTable.init({
		targetId : "MAPP_LIST"
		, columns : [
			{data : "TEST_YR", title : "시험년도", className : "text-center"}
			, {data : "RPRS_YN", title : "대표", className : "text-center"
				, render : function(data, type, rowData, meta) {
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, editType : "radio"
						, checked : "Y"
						, unChecked : "N"
					});
				}
			}
			, {data : "MKR_NM", title : "제조사", className : "text-start"}
			, {data : "CAR_MDL_NM", title : "모델명", className : "text-start"}
			, {data : "CARMDL_1N_NM", title : "차종분류1", className : "text-start"}
			, {data : "CARMDL_2N_NM", title : "차종분류2", className : "text-start"}
			, {data : "FUEL_NM", title : "연료", className : "text-start"}
			, {data : "TRSM_NM", title : "변속기 분류", className : "text-start"}
			, {data : "MNFTR_YR", title : "재조년도", className : "text-center"}
			, {data : "IMG_DELETE", title : "삭제", className : "text-center", width : "100px"
				, render : function(data, type, rowData, meta) {
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, editType : "button"
						, color : "danger"
						, icon : "delete"
					});
				}
			}
		]
		, visibleRowNo : true
		, buttons : [
			{
				type : "btnAddPopup"
				, text : '<i class="fa-solid fa-plus me-2"></i>'+'유사 모델 추가'
				, id : "btnAddPopup"
				, className : "btn-outline-primary"
			}
		]
		, setRowsCallback : function(result, setting) {
			const tableId = setting.table().node().id;
			<!--/* 버튼 이벤트 설정 */-->
			$(`#${tableId}`).on("click", "button", function() {
				const $btn = $(this);
				const rowIdx = $btn.data("row");
				const table = DataTable.getDataTable("MAPP_LIST");
				const rowData = table.row(rowIdx).data();
				
				if($btn.hasClass('btn-danger')){
					DataTable.removeRows(rowIdx, "MAPP_LIST");
				}
			});
		}
	
	});
	
	myapp.searchTree = function(data) {
		Common.ajax({
			url : /*[[@{/car/info/mapping/edit/selectTree}]]*/
			, callback : function(result, textStatus, jqXHR) {
				const zNodes = [];
				$.each(result, function(k, v) {
					var map	= {};
					map.id	 = v.ID;
					map.name	= v.NM;
					if (!Common.isEmpty(v.PID)) {
						map.pId	= v.PID;
					} else {
						map.open = true;
					}
					zNodes.push(map);
				});
		        const setting = {
		            data: {
		                simpleData: {
		                    enable: true,
		                }
		            },
		            callback : {
		            	onNodeCreated: function(event, treeId, treeNode) {
	            	      const zTree = $.fn.zTree.getZTreeObj(treeId);

	            	      if (treeNode.level === 0 && !zTree._firstNodeClicked) {
	            	        zTree.selectNode(treeNode);
	            	        zTree._firstNodeClicked = true;
	            	      }
	            	    },
	            	    onClick: function(event, treeId, treeNode) {
	              	      if(treeNode.level === 0){
	              	    	  myapp.searchInfo({CAR_MDL_GROUP_CD : treeNode.id});
	              	      }else{
	              	    	  return;
	              	      }
	              	    }
		            }
		        }
		        $.fn.zTree.init($("#treeDemo"), setting, zNodes);
		        let zTreeObj = $.fn.zTree.getZTreeObj("treeDemo");
		        
		        <!--/* 저장이후 데이터넘겼을때, 해당 노드 클릭이벤트 발생 */-->
		        if(data){
		        	let node = zTreeObj.getNodeByParam("id", data.CAR_MDL_GROUP_CD, null);
		        	zTreeObj.cancelSelectedNode();
		        	zTreeObj.selectNode(node); 
		        	myapp.searchInfo(data);
		        }else{
		        	<!--/* 초기 데이터 존재시 첫번째 노드 클릭이벤트 */-->
		        	if (zTreeObj && zTreeObj.getNodes().length > 0) {
		        		const firstNode = zTreeObj.getNodes()[0];
		        		zTreeObj.cancelSelectedNode();
		        		zTreeObj.selectNode(firstNode);
		        		zTreeObj.setting.callback.onClick(null, zTreeObj.setting.treeId, firstNode);
	        	    }else{
	        	    	myapp.setView();
	        	    }
		        }
		        
	        	
			}
		});
	}
	myapp.searchTree();
	
	<!--/* 정보 조회 */-->
	myapp.searchInfo = function(data) {
		Common.ajax({
			url : /*[[@{/car/info/mapping/edit/selectInfo}]]*/
			, data : data
			, callback : function(result, textStatus, jqXHR) {
				Common.setFormData("myForm", result);
				myapp.search(data);
			}
		});
	}
	
	<!--/* 목록 조회 */-->
	myapp.search = function(data) {
		Common.ajax({
			url : /*[[@{/car/info/mapping/edit/selectList}]]*/
			, data : data
			, callback : function(result, textStatus, jqXHR) {
				DataTable.setRows({rows : result}, "MAPP_LIST");
			}
		});
	}
	<!--/* 모델 추가 팝업 */-->
	$("#btnAddPopup").click(function() {
		Popup.open({
			id : "mapping"
			, url : "/car/info/popup"
				, options : {
					width : 1350, height : 780
				}
			, closeCallback : function(result, popup) {
				if(result){
					let saveRows = DataTable.getEditRowDataList('MAPP_LIST').saveRows;
					let updatedA = result.filter(aItem => 
				    	!saveRows.some(bItem => aItem.CAR_MDL_CD === bItem.CAR_MDL_CD)
					);
					DataTable.addRows(updatedA, "MAPP_LIST");
				}
				<!--/* popup.close();*/-->
			}
		});
	});
	
   	<!--/* 삭제 */-->
   	myapp.delete = function() {
   		Common.ajax({
   			url : /*[[@{/car/info/mapping/edit/delete}]]*/
   			, toast : "delete"
   			, data : $("#myForm").serializeObject()
   			, callback : function(result, textStatus, jqXHR) {
   				myapp.searchTree();
   			}
   		});
   	}
   	
   	<!--/* 검색 버튼 클릭 이벤트 */-->
   	$("#btnSearch").on("click", function() {
   		myapp.search();
   	});
   	<!--/* input 엔터 이벤트 */-->
   	$("#searchForm :input").keypress(function(e) {
   		if(e.keyCode == 13) {
   			myapp.search();
   		}
   	});
   	<!--/* 저장 버튼 클릭 이벤트 */-->
	$("#btnSave").on("click", function() {
		let formValid = Common.valid($("#myForm"), '자동차 그룹');
		
		if(!formValid.valid) {
			Common.showValidDialog([formValid]);
			return;
		}
		let params = $.extend({formData : $("#myForm").serializeObject()}, DataTable.getEditRowDataList('MAPP_LIST'));
		Common.ajax({
			url : /*[[@{/car/info/mapping/edit/save}]]*/
			, toast : "save"
			, data : params
			, callback : function(result, textStatus, jqXHR) {
				myapp.setView('EDIT');
				myapp.searchTree(result.formData);
			}
		});
	});
   	<!--/* 신규 버튼 클릭 이벤트 */-->
   	$("#btnNew").on("click", function() {
   		myapp.setView("NEW");
   	});
   	<!--/* 삭제 버튼 클릭 이벤트 */-->
   	$("#btnDelete").on("click", function() {
   		myapp.delete();
   	});
   	
   	<!--/* 복사 버튼 */-->
	$("#btnCopy").on("click", function() {
		myapp.setView("COPY");
	});
   	
   	<!--/************ window 함수 선언 ************/-->
   	$(window).resize(function() {
   		DataTable.dataTableResize(); <!--/* DataTables resize */-->
   	});
        
	return myapp;
}());
</script>
</th:block>
</th:block>