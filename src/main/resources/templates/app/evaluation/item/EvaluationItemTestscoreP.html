<th:block layout:decorate="~{${layoutName}}">
	<!-- s : wrapper -->
    <div layout:fragment="pageContent" class="wrapper">
        <!-- s : main-wrap -->
        <div class="main-wrap">
            <!-- s : main -->
            <div class="main">
                <!-- s : 내용 시작 -->
                <div class="card mb-0">
                    <div class="card-body">
                        <div class="row">

                            <div class="col-sm">
                                <!-- e : subtitle-wrap -->
                                <div class="subtitle-wrap row">
                                    <div class="col-md-6">
                                        <h3 class="card-title" id="title">배점기준 설정</h3>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="text-sm-end">
                                            <button id="btnSave" type="button" class="btn btn-primary"><i class="fas fa-check me-2"></i>적용</button>
                                            <button id="btnClose" type="button" class="btn btn-outline-primary">닫기</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row gx-2 mb-4">
                                    <div class="col-sm-2">
                                        <div class="form-check form-check-inline">
                                            <label class="form-check-label all-label required" for="INDIV_YN">기준</label>
                                        </div>
                                    </div>
                                    <div class="col-sm">
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="INDIV_YN" id="INDIV_N" value="N" checked="checked" validText="기준" required="required">
                                            <label class="form-check-label" for="INDIV_N">최소 ~ 최대 구간</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="INDIV_YN" id="INDIV_Y" value="Y" validText="기준" required="required">
                                            <label class="form-check-label" for="INDIV_Y">단일</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="data-table-wrap">
                                	<table id="SCORE_LIST" class="table table-striped w-100 nowrap"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- 페이지 script -->
<th:block layout:fragment="pageScript">
<script th:inline="javascript">
const myapp = (function() {
	let myapp = {};
	let rowData = opener.Popup.openCallback(/*[[${id}]]*/);
	
	$('input[name=INDIV_YN]').on('change',function() {
	    if(this.value === 'Y'){
	    	DataTable.visible(["MIN_SCR", "MAX_SCR"], false, "SCORE_LIST");
	    	DataTable.visible("MIN_MAX_SCR", true, "SCORE_LIST");
	    	
	    } else {
	    	DataTable.visible(["MIN_SCR", "MAX_SCR"], true, "SCORE_LIST");
	    	DataTable.visible("MIN_MAX_SCR", false, "SCORE_LIST");
	    }
	    myapp.refreshInputMask();
	    DataTable.dataTableResize();
	})
	
	DataTable.init({
		targetId : "SCORE_LIST"
		, columns : [
			{data : "SORT_SEQ", title : "정렬순서", className : "text-center", width : "90px"
				, render : function(data, type, rowData, meta) {
					const mask = {
						alias: 'integer'
						, allowMinus: false
						, rightAlign: false
						, removeMaskOnSubmit: true
					}
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, mask : mask
						, editType : "input"
					});
				}
			}
			, {data : "TEST_GRD", title : "등급", className : "text-center th-required", width : "90px"
				, render : function(data, type, rowData, meta) {
					const mask = {
						alias: 'integer'
						, allowMinus: false
						, rightAlign: false
						, removeMaskOnSubmit: true
					}
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, mask : mask
						, required : true
						, editType : "input"
					});
				}
			}
			, {data : "MIN_MAX_SCR", title : "배점", className : "text-center th-required", visible : false, width : "90px"
				, render : function(data, type, rowData, meta) {
					const mask = {
						alias: 'numeric'
						, autoGroup: true
						, digits: 3
						, digitsOptional: false
						, allowMinus: false
						, rightAlign: false
						, removeMaskOnSubmit: true
					}
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, mask : mask
						, required : true
						, editType : "input"
					});
				}
			}
			, {data : "MIN_SCR", title : "최소배점", className : "text-center th-required", width : "90px"
				, render : function(data, type, rowData, meta) {
					const mask = {
						alias: 'numeric'
						, autoGroup: true
						, digits: 3
						, digitsOptional: false
						, allowMinus: false
						, rightAlign: false
						, removeMaskOnSubmit: true
					}
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, mask : mask
						, required : true
						, editType : "input"
					});
				}
			}
			, {data : "MAX_SCR", title : "최대배점", className : "text-center th-required", width : "90px"
				, render : function(data, type, rowData, meta) {
					const mask = {
							alias: 'numeric'
							, autoGroup: true
							, digits: 3
							, digitsOptional: false
							, allowMinus: false
							, rightAlign: false
							, removeMaskOnSubmit: true
						}
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, mask : mask
						, required : true
						, editType : "input"
					});
				}
			}
			, {data : "SCR_EXPLN", title : "배점설명", className : "text-start"
				, render : function(data, type, rowData, meta) {
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, editType : "input"
					});
				}
			}, {data : "IMG_DELETE", title : "삭제", width : "100px", className : "text-center"
				, render : function(data, type, rowData, meta) {
					return DataTable.render({
						type : type, rowData : rowData, meta : meta
						, data : data
						, editType : "button"
						, color : "danger"
						, icon : "delete"
					});
				}
			}
		]
		, order : false
		, visibleRowNo : false
		, updateEditCell : true
		, setRowsCallback : function(result, setting) {
			const tableId = setting.table().node().id;
			<!--/* 버튼 이벤트 설정 */-->
			$(`#${tableId}`).on("click", "button", function() {
				const $btn = $(this);
				const rowIdx = $btn.data("row");
				const table = DataTable.getDataTable("SCORE_LIST");
				const rowData = table.row(rowIdx).data();
				
				if($btn.hasClass('btn-danger')){
					DataTable.removeRows(rowIdx, "SCORE_LIST");
				}
			});
		}
		, UI : {
			head : true
			, head_left : false
			, head_right : true
			, paging : false
		}, buttons : [
			{
		        text : '<i class="fas fa-add me-2"></i>추가'
		        , id : "btnAdd"
		        , className : "btn-primary"
			}
		]
		, valid : function(dataTable, errors) {
			let data = DataTable.getEditRowDataList('SCORE_LIST').saveRows;
			let overlaps = [];
			
			<!--/* 등급 중복검사 */-->
			let counts = data.reduce((acc, item) => {
			    if(item.TEST_GRD != null){
					acc[item.TEST_GRD] = (acc[item.TEST_GRD] || 0) + 1;
			    }
			    return acc;
			}, {});
			let duplicates = Object.keys(counts).filter(key => counts[key] > 1);
			if(duplicates.length > 0){
				let formatted = duplicates.map(val => `'${val}'`).join(',');
				errors.push({
					target : "TEST_GRD"
					, label : '등급'
					, message : [`등급 값 중 ${formatted} 은 중복되었습니다`]
				});
			}
			
			<!--/* 최소,최대값 유효성 */-->
			if($('input[name=INDIV_YN]:checked').val() === 'N'){
				<!--/* 단일행 비교 */-->
				data.forEach((item, index) => {
				    let min = parseFloat(item.MIN_SCR);
				    let max = parseFloat(item.MAX_SCR);
	
				    if (min > max) {
				        errors.push({
							target : "MIN_SCR"
							, label : `최소 ~ 최대배점 부적합(${index + 1} 행)`
							, message : ["최소배점이 최대배점보다 작아야 합니다."]
						});
				    }
				});
				
				<!--/* 전체행 비교 */-->
				let ranges = data
				    .map((item, index) => {
				        let min = parseFloat(item.MIN_SCR);
				        let max = parseFloat(item.MAX_SCR);
				        return (!isNaN(min) && !isNaN(max)) ? { index: index + 1, min, max } : null;
				    })
				    .filter(Boolean);
				for (let i = 0; i < ranges.length; i++) {
				    let a = ranges[i];
				    for (let j = i + 1; j < ranges.length; j++) {
				        let b = ranges[j];
				        let isOverlap = a.min <= b.max && a.max >= b.min;
				        if (isOverlap) {
				            errors.push({
								target : "MIN_SCR"
								, label : `최소 ~ 최대배점 부적합(${a.index} 행, ${b.index} 행)`
								, message : [`(${a.min}~${a.max}) 와 (${b.min}~${b.max}) 의 범위가 겹칩니다.`]
							});
				        }
				    }
				}
			}else{
				<!--/* 배점 중복검사 */-->
				let counts = data.reduce((acc, item) => {
				    if(item.MIN_MAX_SCR != null){
						acc[item.MIN_MAX_SCR] = (acc[item.MIN_MAX_SCR] || 0) + 1;
				    }
				    return acc;
				}, {});
				let duplicates = Object.keys(counts).filter(key => counts[key] > 1);
				if(duplicates.length > 0){
					let formatted = duplicates.map(val => `'${val}'`).join(',');
					errors.push({
						target : "MIN_MAX_SCR"
						, label : '배점'
						, message : [`배점 ${formatted} 은 중복되었습니다`]
					});
				}
			}
			return errors;
		}
	});
	
	myapp.refreshInputMask = function(props){
		$("input").each(function(){
	        if($(this).attr("data-inputmask")){
	            var options = {autoUnmask:true,autoGroup:true,groupSeparator:","};
	            if (props != undefined) {
	              $.extend(options, props);
	            }
	            $(this).inputmask(options);
	        }
	    });	
	}
	myapp.refreshInputMask();
	
	myapp.search = function() {
		let obj = rowData["CHILD"];
		if(obj){ <!--/* 수정이력이 존재하면 CHILD 생성됨 */-->
			$('input[name=INDIV_YN][value="'+obj["INDIV_YN"]+'"]').prop('checked', true).trigger('change');
			DataTable.setRows({rows :{ data : obj["saveRows"]}, data : null}, "SCORE_LIST");
		} else { <!--/* 수정이력이 없다면 초기조회 */-->
			let params = {};
			params["TEST_ARTCL_PRD_CD"] = rowData.TEST_ARTCL_PRD_CD;
			Common.ajax({
				url :  /*[[@{/evaluation/item/testscore/popup/selectScoreInfo}]]*/
				, data : params
				, callback : function(result, textStatus, jqXHR) {
					if(result){
						$('input[name=INDIV_YN][value="'+result.INDIV_YN+'"]').prop('checked', true).trigger('change');
					}
				}
			});
			Common.ajax({
				url :  /*[[@{/evaluation/item/testscore/popup/selectScoreList}]]*/
				, data : params
				, callback : function(result, textStatus, jqXHR) {
					DataTable.setRows({rows : result, data : null}, "SCORE_LIST");
				}
			});
		}
	}
	myapp.search();
	
	$("#btnSave").click(function() {
		let tableValid = DataTable.valid("SCORE_LIST");
		if(!tableValid.valid) {
			Common.showValidDialog([tableValid]);
			return;
		}
		
		let params = {INDIV_YN : $('input[name=INDIV_YN]:checked').val()};
		$.extend(params, DataTable.getEditRowDataList('SCORE_LIST'));
		
		opener.Popup.closeCallback(/*[[${id}]]*/, params);
	});
	
	$("#btnAdd").click(function() {
		DataTable.addRows([{}], "SCORE_LIST");
	});
	
	$("#btnClose").click(function() {
		window.close();
	});
	
	<!--/************ window 함수 선언 ************/-->
	$(window).resize(function() {
		DataTable.dataTableResize(); <!--/* DataTables resize */-->
	});
	
	return myapp;
}());
</script>
</th:block>
</th:block>