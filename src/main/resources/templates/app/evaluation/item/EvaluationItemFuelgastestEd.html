<th:block layout:decorate="~{${layoutName}}">
<!-- 페이지 content(ui) -->
<main layout:fragment="pageContent" class="content">
	<div class="container-fluid p-0">
		<!-- s : 내용 시작 -->
		<div class="row align-items-center content-head">
			<div class="col-md-6">
				<h2 class="h1 mb-0 col-md-auto">연비ㆍ온실가스 시험항목 등록</h2>
			</div>
			<div class="col-md-6">
				<nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
					<ol class="breadcrumb mb-0 justify-content-end">
						<li class="breadcrumb-item" aria-current="page"><i class="fas fa-home me-1"></i>홈</li>
						<li class="breadcrumb-item" aria-current="page">평가 항목 관리</li>
						<li class="breadcrumb-item" aria-current="page">연비ㆍ온실가스 시험항목</li>
					</ol>
				</nav>
			</div>
		</div>
		<div class="row">
			<!-- s : 왼쪽 -->
			<div class="col-md-6">
				<!-- s : card -->
				<div class="card">
					<div class="card-body">
						<!-- s : subtitle-wrap -->
						<div class="subtitle-wrap row">
							<div class="col-md-6">
								<h3 class="card-title">연비ㆍ온실가스 시험항목 목록</h3>
							</div>
							<div class="col-md-6">
								<div class="text-sm-end">
									<button id="btnSearch" class="btn btn-secondary"><i class="fas fa-search me-2"></i>검색</button>
									<button id="btnDeleteSelect" class="btn btn-outline-primary" disabled><i class="fa-solid fa-trash-can me-2"></i>일괄 삭제</button>
								</div>
							</div>
						</div>
						<!-- e : subtitle-wrap -->
						<!-- s : sub-box -->
						<div class="sub-box">
							<form id="searchForm">
								<div class="table-form">
									<table class="table table-bordered align-middle">
										<colgroup>
											<col width="110">
											<col width="*">
											<col width="110">
											<col width="*">
										</colgroup>
										<tbody>
											<tr>
												<th>
													<label for="SEARCH_TEST_ARTCL_NM" class="col-form-label">시험항목명</label>
												</th>
												<td>
													<input type="text" id="SEARCH_TEST_ARTCL_NM" name="SEARCH_TEST_ARTCL_NM" class="form-control">
												</td>
												<th>
													<label for="SEARCH_RLS_YN" class="col-form-label">공개여부</label>
												</th>
												<td>
													<div class="form-check form-check-inline">
			                                            <input class="form-check-input" type="checkbox" name="SEARCH_RLS_YN" id="SEARCH_RLS_YN_1" value="Y" checked>
			                                            <label class="form-check-label" for="SEARCH_RLS_YN_1">공개</label>
			                                        </div>
			                                        <div class="form-check form-check-inline">
			                                            <input class="form-check-input" type="checkbox" name="SEARCH_RLS_YN" id="SEARCH_RLS_YN_2" value="N" checked>
			                                            <label class="form-check-label" for="SEARCH_RLS_YN_2">비공개</label>
			                                        </div>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</form>
							<article class="alert-box">
								<div class="alert-title"><i class="fas fa-exclamation-circle me-2"></i>안내사항</div>
								<ul class="alert-list">
									<li>시작연도와 종료연도는 최종적용 연도가 조회됩니다.</li>
								</ul>
							</article>
							<!-- s : data-table-wrap -->
							<div class="data-table-wrap">
								<table id="TEST_LIST" class="table table-striped w-100 nowrap"></table>
							</div>
							<!-- e : data-table-wrap -->
						</div>
						<!-- e : sub-box -->
					</div>
				</div>
				<!-- e : card -->
			</div>
			<!-- e : 왼쪽 -->
			<!-- s : 오른쪽 -->
			<div class="col-md-6">
				<div class="card">
					<div class="card-body">
						<div class="subtitle-wrap row">
							<div class="col-md-6">
								<h3 class="card-title">연비ㆍ온실가스 시험항목 정보</h3>
							</div>
							<div class="col-md-6">
								<div class="text-sm-end">
									<button id="btnSave" class="btn btn-primary"><i class="fas fa-save me-2"></i>저장</button>
									<button id="btnNew" class="btn btn-outline-primary "><i class="fas fa-plus me-2"></i>신규</button>
									<button id="btnDelete" class="btn btn-outline-primary"><i class="fa-solid fa-trash me-2"></i>삭제</button>
								</div>
							</div>
						</div>
						<div class="table-form">
							<form id="myForm">
								<table class="table table-bordered align-middle">
									<colgroup>
										<col width="110">
										<col width="*">
										<col width="110">
										<col width="*">
									</colgroup>
									<tbody>
										<tr>
											<th>
												<label for="UP_TEST_ARTCL_NM" class="col-form-label">주요 시험항목</label>
											</th>
											<td colspan="3">
												<input type="text" value="연비ㆍ온실가스" id="UP_TEST_ARTCL_NM" name="UP_TEST_ARTCL_NM" class="form-control readonly excludeFormClear" readonly>
											</td>
										</tr>
										<tr>
											<th>
												<label for="TEST_ARTCL_NM" class="col-form-label required">시험항목명</label>
											</th>
											<td colspan="3">
												<input type="text" id="TEST_ARTCL_NM" name="TEST_ARTCL_NM" class="form-control" required>
											</td>
										</tr>
										<tr>
											<th>
												<label for="RLS_YN" class="col-form-label required">공개여부</label>
												<i class="fas fa-question-circle tooltips" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true" title="비공개로 설정시 대국민 서비스 모두 화면에 표시되지 않습니다."></i>
											</th>
											<td>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="RLS_YN" id="RLS_YN_Y" validText="공개여부" value="Y" required checked>
                                                    <label class="form-check-label" for="RLS_YN_Y">공개</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="RLS_YN" id="RLS_YN_N" validText="공개여부" value="N" required>
                                                    <label class="form-check-label" for="RLS_YN_N">비공개</label>
                                                </div>
                                            </td>
											<th>
												<label for="UNIT_CD" class="col-form-label">단위</label> 
											</th>
											<td>
	                                            <select id="UNIT_CD" name="UNIT_CD" class="form-select">
	                                                <option value="" selected="selected">선택</option>
	                                                <option th:each="item : ${dsUnit}" th:value="${item.UNIT_CD}" th:text="${item.UNIT_NM}"></option>
	                                            </select>
	                                        </td>
										</tr>
										<tr>
											<th>
												<label for="SORT_SEQ" class="col-form-label">정렬순서</label>
											</th>
											<td colspan="3">
												<input type="text" id="SORT_SEQ" name="SORT_SEQ" class="form-control" data-inputmask="'alias':'integer','allowMinus':'false'">
											</td>
										</tr>
										<tr>
											<th>
												<label for="MDFCN_DT" class="col-form-label">최종수정일</label>
											</th>
											<td><input type="text" id="MDFCN_DT" name="MDFCN_DT" class="form-control readonly" readonly></td>
											<th>
												<label for="MDFCN_USER_NM" class="col-form-label">최종수정자</label>
											</th>
											<td><input type="text" id="MDFCN_USER_NM" name="MDFCN_USER_NM" class="form-control readonly" readonly></td>
										</tr>
									</tbody>
								</table>
							</form>
						</div>
					</div>
				</div>
				
				<div class="card">
					<div class="card-body">
						<div class="subtitle-wrap row">
							<div class="col-md-6">
								<h3 class="card-title" id="title">적용기간 및 배점</h3>
							</div>
							<div class="col-md-6">
								<div class="text-sm-end">
									<button id="btnAdd" class="btn btn-primary"><i class="fas fa-add me-2"></i>추가</button>
								</div>
							</div>
						</div>
						<div class="table-form">
							<table id="PRD_LIST" class="table table-striped w-100 nowrap"></table>
						</div>
					</div>
				</div>
				
			</div>
			<!-- e : 오른쪽 -->
		</div>

		<!-- e : 내용 끝 -->
	</div>
</main>
<!-- 페이지 script -->
<th:block layout:fragment="pageScript">
	<script th:inline="javascript">
	const myapp = (function() {
		let myapp = {};
		
		$("select").select2();
		
		<!--/* 조회 설정 */-->
		myapp.setView = function(viewType) {
			if(viewType == "NEW") {
				$("#btnDelete").prop("disabled", true);
				$("#btnSave, #btnAdd, #myForm :disabled").prop("disabled", false);
				<!--/* 신규 버튼 클릭시 */-->
				Common.clearFormData("myForm");
				let table = DataTable.getDataTable("PRD_LIST");
				table.clear();
				myapp.searchInfo();
			}else if(viewType == "EDIT") {
				$("#btnSave, #btnDelete, #btnAdd, #myForm :input:disabled").prop("disabled", false);
			}else {
				$("#btnSave, #btnDelete, #btnAdd, #myForm :input:not([readonly])").prop("disabled", true);
				Common.clearFormData("myForm");
			}
		}
		
		<!--/************ DataTable 선언 ************/-->
		DataTable.init({
			targetId : "TEST_LIST"
			, columns : [
				{data : "TEST_ARTCL_NM", title : "시험항목명", className : "text-start cell-select", width : "400px"}
				, {data : "UNIT_NM", title : "단위", className : "text-start", width : "100px"}
				, {data : "RLS_YN", title : "공개여부", width : "100px", className : "text-center", width : "100px"
					, render : function(data, type, rowData, meta) {
						return data == "Y" ? "공개" : "비공개";
					}
				}
				, {data : "SCORE", title : "배점", width : "300px", className : "text-center", width : "100px"}
				, {data : "APLCN_BGNG_YR", title : "적용시작연도", className : "text-center", width : "200px"}
				, {data : "APLCN_END_YR", title : "적용종료연도", className : "text-center", width : "200px"}
			]
			, visibleRowNo : true
			, buttons : [
				{
					type : "excel"
					, fileName : "연비ㆍ온실가스 시험항목 목록"
				}
			]
			, cellClick : function(rowData, row) {
				myapp.searchInfo(rowData);
			}
			, setRowsCallback : function(result, setting) {
				if(Common.isEmpty(result.data) == false) {
					myapp.searchInfo(result.data);
				}else if(Common.isEmpty(result.rows.data[0]) == false) {
					myapp.searchInfo(result.rows.data[0]);
				}
			}
			, initCallback : function(result, settings) {
				myapp.setView();
			}
			, rowSelectCallback : function(e) {
				let selectedData = DataTable.getSelectedRows();
				$("#btnDeleteSelect").prop("disabled", selectedData.length == 0);
			}
			, checkedRows : true
		});
		
		DataTable.init({
			targetId : "PRD_LIST"
			, columns : [
				{data : "APLCN_BGNG_YR", title : "적용시작연도", className : "text-center th-required", width : "100px"
					, render : function(data, type, rowData, meta) {
						return DataTable.render({
							type : type, rowData : rowData, meta : meta
							, data : data
							, editType : "date"
							, endDate : "APLCN_END_YR"
							, required : true
							, validText : "적용시작연도"
							, pickerOptions : {
								view :  "years"
							}
							, disabled : rowData.MAX_FLAG === 'Y' ? false : true
						});
					}
				}
				, {data : "APLCN_END_YR", title : "적용종료연도", className : "text-center th-required", width : "100px"
					, render : function(data, type, rowData, meta) {
						return DataTable.render({
							type : type, rowData : rowData, meta : meta
							, data : data
							, editType : "date"
							, required : true
							, validText : "적용종료연도"
							, pickerOptions : {
								view :  "years"
							}
							, disabled : rowData.MAX_FLAG === 'Y' ? false : true
						});
					}
				}
				, {data : "DRCT_INPT_YN", title : "배점구분", className : "text-center", width : "150px"
					, render : function(data, type, rowData, meta) {
						return DataTable.render({
							type : type, rowData : rowData, meta : meta
							, data : data
							, editType : "select"
							, options : [
								{value : "N", text : "배점"}
								, {value : "Y", text : "직접입력"}
							]
							, disabled : rowData.MAX_FLAG === 'Y' ? false : true
						});
					}
				}
				, {data : "SCORE", title : "배점", className : "text-center", width : "150px"
					, render : function(data, type, rowData, meta) {
						return DataTable.render({
							type : type, rowData : rowData, meta : meta
							, data : data
							, editType : "input"
							, readonly : true
							, className : 'text-center'
						});
					}
				}
				, {data : "IMG_MODIFY", title : "편집", className : "text-center", width : "100px"
					, render : function(data, type, rowData, meta) {
						return DataTable.render({
							type : type, rowData : rowData, meta : meta
							, data : data
							, editType : "button"
							, color : "info"
							, icon : "edit"
							, style : {display: rowData.MAX_FLAG === 'Y' && rowData.DRCT_INPT_YN === 'N' ? 'inline' : 'none'}
						});
					}
				}
				, {data : "IMG_DELETE", title : "삭제", className : "text-center", width : "100px"
					, render : function(data, type, rowData, meta) {
						return DataTable.render({
							type : type, rowData : rowData, meta : meta
							, data : data
							, editType : "button"
							, color : "danger"
							, icon : "delete"
							, style : {display: rowData.MAX_FLAG === 'Y' ? 'inline' : 'none'}
						});
					}
				}
			]
			, order : false
			, visibleRowNo : false
			, updateEditCell : true
			, setRowsCallback : function(result, setting) {
				const tableId = setting.table().node().id;
				<!--/* 버튼 이벤트 설정 */-->
				$(`#${tableId}`).on("click", "button", function() {
					const $btn = $(this);
					const rowIdx = $btn.data("row");
					const table = DataTable.getDataTable("PRD_LIST");
					const rowData = table.row(rowIdx).data();
					
					if($btn.hasClass('btn-info')){
						Popup.open({
							id : "testscore"
							, url : "/evaluation/item/testscore/popup"
 							, options : {
 								width : 830, height : 520
 							}
							, openCallback : function() {
								$.extend(rowData);
								return rowData;
							}
							, closeCallback : function(result, popup) {
								$.extend(rowData, {CHILD : result});
								popup.close();
								
								<!--/* 배점 계산 */-->
								if(result.saveRows.length > 0) {
								    const isIndividual = result.INDIV_YN === 'Y';
								    const saveRows = result.saveRows;

								    let parseValidNumbers = (arr, key) =>
								        arr.map(item => parseFloat(item[key])).filter(num => !isNaN(num));

								    if (isIndividual) {
								    	let minMaxScores = parseValidNumbers(saveRows, 'MIN_MAX_SCR');
								    	let minScr = Math.min(...minMaxScores);
								        let maxScr = Math.max(...minMaxScores);
								    	
								        DataTable.setColumnData({ row: rowIdx, column: "SCORE", data: `${minScr} ~ ${maxScr}` },"PRD_LIST");
								    } else {
								        let minScores = parseValidNumbers(saveRows, 'MIN_SCR');
								        let maxScores = parseValidNumbers(saveRows, 'MAX_SCR');

								        let minScr = Math.min(...minScores);
								        let maxScr = Math.max(...maxScores);

								        DataTable.setColumnData({ row: rowIdx, column: "SCORE", data: `${minScr} ~ ${maxScr}` },"PRD_LIST");
								    }
								}
							}
						});
					} else if($btn.hasClass('btn-danger')){
						DataTable.removeRows(rowIdx, "PRD_LIST");
						if($('select[data-row='+(rowIdx-1)+']').val() !== 'Y'){
							$('.btn-info[data-row='+(rowIdx-1)+']').show();
						}
						$('.btn-danger[data-row='+(rowIdx-1)+']').show();
						$('input[data-row='+(rowIdx-1)+']').prop('disabled', false);
						$('select[data-row='+(rowIdx-1)+']').prop('disabled', false);
					}
					DataTable.dataTableResize();
				});
				<!--/* 콤보박스 이벤트 설정 */-->
				$(`#${tableId}`).on("change", "select", function() {
					const $select = $(this);
					const rowIdx = $select.data("row");
				    const $btn = $(`#${tableId} button.btn-info[data-row="${rowIdx}"]`);
					const table = DataTable.getDataTable(`#${tableId}`);
				    const value = $select.val();
				    
					if(value === 'Y'){
						$btn.hide();
						DataTable.setColumnData({ row: rowIdx, column: "SCORE", data: null },"PRD_LIST");
					} else {
						$btn.show();
					}
				});
				
				$('#PRD_LIST select[data-name="DRCT_INPT_YN"]').on('change', function () {
				    const $select = $(this);
				    const row = $select.data('row');
				    const value = $select.val();
				    const $deleteBtn = $(`#PRD_LIST button.btn-info[data-row="${row}"]`);
				    if (value === 'Y') {
				        $deleteBtn.hide(); 
				    } else {
				        $deleteBtn.show(); 
				    }
				});
				
			}
			, UI : {
				head : false
				,paging : false
			}, valid : function(dataTable, errors) {
				const data = DataTable.getEditRowDataList('PRD_LIST').saveRows;
				const overlaps = [];
				for (let i = 0; i < data.length; i++) {
				    const a = data[i];
				    const aStart = parseInt(a.APLCN_BGNG_YR);
				    const aEnd = parseInt(a.APLCN_END_YR);
				    if (isNaN(aStart) || isNaN(aEnd)) continue;
				    for (let j = i + 1; j < data.length; j++) {
				        const b = data[j];
				        const bStart = parseInt(b.APLCN_BGNG_YR);
				        const bEnd = parseInt(b.APLCN_END_YR);
				        if (isNaN(bStart) || isNaN(bEnd)) continue;
				        
				        const isOverlap = aStart <= bEnd && bStart <= aEnd;
				        if (isOverlap) {
				            overlaps.push({
				                indexA: i+1,
				                indexB: j+1,
				                rangeA: `${aStart} ~ ${aEnd}`,
				                rangeB: `${bStart} ~ ${bEnd}`
				            });
				        }
				    }
				}
				if (overlaps.length > 0) {
				    overlaps.forEach(o => {
				    	errors.push({
							target : "APLCN_BGNG_YR"
							, label : `적용연도 부적합(${o.indexA}행,${o.indexB}행)`
							, message : [`(${o.rangeA})와 (${o.rangeB}) 가 겹칩니다.`]
						});
				    });
				} 
				return errors;
			}
		});
		
		<!--/* 목록 조회 */-->
		myapp.search = function(data) {
			myapp.setView("EDIT");
			
			Common.ajax({
				url : /*[[@{/evaluation/item/fuelgastest/edit/selectList}]]*/
				, data : $("#searchForm").serializeObject()
				, callback : function(result, textStatus, jqXHR) {
					DataTable.setRows({rows : result, data : data}, "TEST_LIST");
					if(result.data.length === 0){
						myapp.setView();
					}
				}
			});
		}
		myapp.search();
		
		<!--/* 상세 조회 */-->
		myapp.searchInfo = function(data){
			<!--/* info 조회 */-->
			Common.ajax({
				url : /*[[@{/evaluation/item/fuelgastest/edit/selectInfo}]]*/
				, data : data
				, callback : function(result, textStatus, jqXHR) {
					Common.setFormData("myForm", result);
				}
			});
			<!--/* 적용기간 조회 */-->
			Common.ajax({
				url :  /*[[@{/evaluation/item/fuelgastest/edit/selectApplyList}]]*/
				, data : data
				, callback : function(result, textStatus, jqXHR) {
					DataTable.setRows({rows : result, data : data}, "PRD_LIST");
				}
			});
		}
		
		<!--/************ Form Event 선언 ************/-->
		<!--/* 검색 버튼 클릭 이벤트 */-->
		$("#btnAdd").click(function() {
			DataTable.addRows([{MAX_FLAG:'Y', DRCT_INPT_YN:'N'}], "PRD_LIST");
		});
		<!--/* 검색 버튼 클릭 이벤트 */-->
		$("#btnSearch").click(function() {
			myapp.search();
		});
		<!--/* input 엔터 이벤트 */-->
		$("#searchForm :input").keypress(function(e) {
			if(e.keyCode == 13) {
				myapp.search();
			}
		});
		<!--/* 저장 버튼 클릭 이벤트 */-->
		$("#btnSave").click(function() {
			let tableValid = DataTable.valid("PRD_LIST");
			let formValid = Common.valid($("#myForm"), "연비ㆍ온실가스 시험항목 정보");
			if(!tableValid.valid || !formValid.valid) {
				Common.showValidDialog([formValid, tableValid]);
				return;
			}
			
			let params = $.extend({formData : $("#myForm").serializeObject()}, DataTable.getEditRowDataList('PRD_LIST'));
			Common.ajax({
				url : /*[[@{/evaluation/item/fuelgastest/edit/save}]]*/
				, toast : "save"
				, data : params
				, callback : function(result, textStatus, jqXHR) {
					myapp.search(result);
				}
			});
		});
		<!--/* 삭제 */-->
		myapp.delete = function(list) {
			Common.ajax({
				url : /*[[@{/evaluation/item/fuelgastest/edit/delete}]]*/
				, toast : "delete"
				, data : {list : list}
				, callback : function(result, textStatus, jqXHR) {
					myapp.search();
				}
			});
		}
		<!--/* 신규 버튼 클릭 이벤트 */-->
		$("#btnNew").on("click", function() {
			myapp.setView("NEW");
		});
		<!--/* 삭제 버튼 클릭 이벤트 */-->
		$("#btnDelete").on("click", function() {
			myapp.delete([$("#myForm").serializeObject()]);
		});
		<!--/* 일괄 삭제 버튼 클릭 이벤트 */-->
		$("#btnDeleteSelect").on("click", function() {
			myapp.delete(DataTable.getSelectedRows());
		});
		<!--/************ window 함수 선언 ************/-->
		$(window).resize(function() {
			DataTable.dataTableResize(); <!--/* DataTables resize */-->
		});
		
		return myapp;
	}());
	</script>
</th:block>
</th:block>